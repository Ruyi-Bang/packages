name: Build, Version, Publish to GitHub Packages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }   # need history for counting
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
      - uses: gradle/actions/setup-gradle@v3
      - name: Build
        run: ./gradlew build --no-daemon

  compute_version:
    runs-on: ubuntu-latest
    needs: build
    if: ${{ success() }}
    outputs:
      version: ${{ steps.ver.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Compute version from base in build.gradle (no timestamps)
        id: ver
        shell: bash
        run: |
          set -e

          # 1) Read the base "X.Y" from build.gradle default like: version = (... ?: "1.0-SNAPSHOT")
          BASE=$(grep -oP 'version\s*=\s*\(findProperty\("projectVersion"\)\s*\?:\s*"\K[0-9]+\.[0-9]+(?=-SNAPSHOT")' build.gradle)
          if [[ -z "$BASE" ]]; then
            echo "Could not parse base version from build.gradle"; exit 1
          fi
          MAJOR="${BASE%%.*}"
          MINOR="${BASE#*.}"

          # 2) Find the last commit where that exact base default was set
          LAST_BASE_COMMIT=$(git log -n 1 -G "version\s*=\s*\(findProperty\(\"projectVersion\"\)\s*\?:\s*\"${BASE}-SNAPSHOT\"" --pretty=format:%H -- build.gradle || true)
          if [[ -z "$LAST_BASE_COMMIT" ]]; then
            # fallback to repo root (first commit) if not found
            LAST_BASE_COMMIT=$(git rev-list --max-parents=0 HEAD)
          fi

          # 3) Count commits since that commit (excluding it)
          COUNT=$(git rev-list "${LAST_BASE_COMMIT}..HEAD" --count)

          # First commit after changing the base => COUNT=0 -> version = MAJOR.MINOR
          # Next commit => COUNT=1 -> MAJOR.(MINOR+1), etc.
          NEW_MINOR=$(( MINOR + COUNT ))
          V="${MAJOR}.${NEW_MINOR}"

          echo "Computed base: $BASE; last-base-commit: $LAST_BASE_COMMIT; count-since: $COUNT"
          echo "version=$V" >> "$GITHUB_OUTPUT"
          echo "Computed version: $V"
      - name: Verify secrets present
        run: |
          test -n "${{ secrets.GPR_USER }}" || (echo "Missing GPR_USER" && exit 1)
          test -n "${{ secrets.GPR_KEY }}"  || (echo "Missing GPR_KEY" && exit 1)
          echo "Secrets exist."

  publish:
    runs-on: ubuntu-latest
    needs: compute_version
    if: ${{ success() }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
      - uses: gradle/actions/setup-gradle@v3
      - name: Publish
        run: ./gradlew publish --no-daemon -PprojectVersion='${{ needs.compute_version.outputs.version }}'
        env:
          ORG_GRADLE_PROJECT_githubUsername: ${{ secrets.GPR_USER }}
          ORG_GRADLE_PROJECT_githubToken:   ${{ secrets.GPR_KEY }}
          GPR_USER: ${{ secrets.GPR_USER }}
          GPR_KEY:  ${{ secrets.GPR_KEY }}
