name: Reusable Build, Version, Publish to GitHub Packages

on:
  workflow_call:
    inputs:
      java-version:
        type: string
        required: false
        default: '21'
      distribution:
        type: string
        required: false
        default: 'temurin'
      publish-url:
        type: string
        required: false
        default: 'https://maven.pkg.github.com/Ruyi-Bang/packages'
      gradle-task:
        type: string
        required: false
        default: 'publish'         # used in the publish job only
      version-prop:
        type: string
        required: false
        default: 'projectVersion'
      extra-args:
        type: string
        required: false
        default: ''
    secrets:
      GPR_KEY:
        required: true

  workflow_dispatch:
  push:
    branches: [ main ]

permissions:
  contents: read
  packages: write

concurrency:
  group: publish-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # 1) Checkout the CALLER repo (default)
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      # 2) Checkout the PACKAGES repo to get the shared init script
      - name: Checkout central init scripts
        uses: actions/checkout@v4
        with:
          repository: Ruyi-Bang/packages
          path: .central
          fetch-depth: 1

      - uses: actions/setup-java@v4
        with:
          distribution: ${{ inputs.distribution }}
          java-version: ${{ inputs['java-version'] }}

      - uses: gradle/actions/setup-gradle@v4

      - name: Build
        env:
          PUBLISH_URL: ${{ inputs['publish-url'] }}
          GPR_USER:    ${{ github.actor }}
          GPR_TOKEN:   ${{ secrets.GPR_KEY }}
          ORG_GRADLE_PROJECT_gpr.user:  ${{ github.actor }}
          ORG_GRADLE_PROJECT_gpr.token: ${{ secrets.GPR_KEY }}
        run: |
          INIT=".central/ci/init/github-packages.gradle"
          ./gradlew -I "$INIT" build --no-daemon

  compute_version:
    runs-on: ubuntu-latest
    needs: build
    if: ${{ success() }}
    outputs:
      version: ${{ steps.ver.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Compute version from base in build.gradle (no timestamps)
        id: ver
        shell: bash
        run: |
          set -euo pipefail
          FILE="build.gradle"
          [[ -f "$FILE" ]] || { echo "Expected $FILE in repo root; change FILE if using build.gradle.kts"; exit 1; }

          BASE=$(grep -oP 'version\s*=\s*\(findProperty\("projectVersion"\)\s*\?:\s*"\K[0-9]+\.[0-9]+(?=-SNAPSHOT")' "$FILE" || true)
          [[ -n "$BASE" ]] || { echo "Could not parse base version from $FILE"; exit 1; }

          MAJOR="${BASE%%.*}"; MINOR="${BASE#*.}"
          LAST_BASE_COMMIT=$(git log -n 1 -G "version\s*=\s*\(findProperty\(\"projectVersion\"\)\s*\?:\s*\"${BASE}-SNAPSHOT\"" --pretty=format:%H -- "$FILE" || true)
          [[ -n "$LAST_BASE_COMMIT" ]] || LAST_BASE_COMMIT=$(git rev-list --max-parents=0 HEAD)
          COUNT=$(git rev-list "${LAST_BASE_COMMIT}..HEAD" --count)
          NEW_MINOR=$(( MINOR + COUNT ))
          V="${MAJOR}.${NEW_MINOR}"

          echo "version=$V" >> "$GITHUB_OUTPUT"
          echo "Computed version=$V from base=$BASE (since $COUNT commits)"

      - name: Verify secret present
        run: |
          test -n "${{ secrets.GPR_KEY }}" || (echo "Missing GPR_KEY" && exit 1)
          echo "Secret present."

  publish:
    runs-on: ubuntu-latest
    needs: compute_version
    if: ${{ success() }}
    steps:
      # 1) Checkout caller repo
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      # 2) Checkout central init script
      - name: Checkout central init scripts
        uses: actions/checkout@v4
        with:
          repository: Ruyi-Bang/packages
          path: .central
          fetch-depth: 1

      - uses: actions/setup-java@v4
        with:
          distribution: ${{ inputs.distribution }}
          java-version: ${{ inputs['java-version'] }}

      - uses: gradle/actions/setup-gradle@v4

      - name: Publish to GitHub Packages
        env:
          PUBLISH_URL: ${{ inputs['publish-url'] }}
          GPR_USER:    ${{ github.actor }}
          GPR_TOKEN:   ${{ secrets.GPR_KEY }}
          GPR_KEY:     ${{ secrets.GPR_KEY }}
          ORG_GRADLE_PROJECT_gpr.user:       ${{ github.actor }}
          ORG_GRADLE_PROJECT_gpr.token:      ${{ secrets.GPR_KEY }}
          ORG_GRADLE_PROJECT_githubUsername: ${{ github.actor }}
          ORG_GRADLE_PROJECT_githubToken:    ${{ secrets.GPR_KEY }}
        run: |
          INIT=".central/ci/init/github-packages.gradle"
          ./gradlew -I "$INIT" ${{ inputs['gradle-task'] }} \
            --no-daemon \
            -P${{ inputs['version-prop'] }}='${{ needs.compute_version.outputs.version }}' \
            ${{ inputs['extra-args'] }}
