name: Reusable Build, Version, Publish to GitHub Packages

on:
  # Callable from other repos
  workflow_call:
    inputs:
      java-version:
        type: string
        default: '21'
      distribution:
        type: string
        default: 'temurin'
      publish-url:
        type: string
        default: 'https://maven.pkg.github.com/Ruyi-Bang/packages'
      gradle-task:
        type: string
        default: 'publish'
      version-prop:
        type: string
        default: 'projectVersion'
      extra-args:
        type: string
        default: ''
      module-path:            # <-- NEW: subproject directory (e.g., services/token-service)
        type: string
        default: '.'
      build-file:             # <-- NEW: 'build.gradle' or 'build.gradle.kts'
        type: string
        default: 'build.gradle'
    secrets:
      GPR_KEY:
        required: true

  # Optional manual test from this repo only
  workflow_dispatch:

permissions:
  contents: read
  packages: write

concurrency:
  group: publish-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # 1) Checkout the CALLER repo
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      # 2) Checkout central init script from packages repo
      - name: Checkout central init scripts
        uses: actions/checkout@v4
        with:
          repository: Ruyi-Bang/packages
          path: .central
          fetch-depth: 1

      - uses: actions/setup-java@v4
        with:
          distribution: ${{ inputs.distribution }}
          java-version: ${{ inputs['java-version'] }}

      - uses: gradle/actions/setup-gradle@v4

      - name: Build (uses central init for repos/creds)
        env:
          PUBLISH_URL: ${{ inputs['publish-url'] }}
          GPR_USER:    ${{ github.actor }}
          GPR_TOKEN:   ${{ secrets.GPR_KEY }}
          ORG_GRADLE_PROJECT_gpr.user:  ${{ github.actor }}
          ORG_GRADLE_PROJECT_gpr.token: ${{ secrets.GPR_KEY }}
        run: |
          INIT=".central/ci/init/github-packages.gradle"
          ./gradlew -I "$INIT" build --no-daemon

  compute_version:
    runs-on: ubuntu-latest
    needs: build
    outputs:
      version: ${{ steps.ver.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Compute version for module (commit-count based)
        id: ver
        shell: bash
        env:
          MODULE_PATH: ${{ inputs.module-path }}
          BUILD_FILE:  ${{ inputs.build-file }}
          VERSION_PROP: ${{ inputs['version-prop'] }}
        run: |
          set -euo pipefail

          FILE="$MODULE_PATH/$BUILD_FILE"
          [[ -f "$FILE" ]] || { echo "Expected $FILE"; exit 1; }

          # Try Groovy then KTS pattern
          BASE_GROOVY=$(grep -oP "version\s*=\s*\(findProperty\(\"${VERSION_PROP}\"\)\s*\?:\s*\"\K[0-9]+\.[0-9]+(?=-SNAPSHOT\")" "$FILE" || true)
          BASE_KTS=$(grep -oP "version\s*=\s*\(findProperty\(\"${VERSION_PROP}\"\)\s*as\s*String\?\s*\?\:\s*\"\K[0-9]+\.[0-9]+(?=-SNAPSHOT\")" "$FILE" || true)
          BASE="${BASE_GROOVY:-${BASE_KTS:-}}"
          [[ -n "$BASE" ]] || { echo "Could not parse base version from $FILE"; exit 1; }

          MAJOR="${BASE%%.*}"; MINOR="${BASE#*.}"

          # Last commit where that exact base default string exists in FILE
          LAST_BASE_COMMIT=$(git log -n 1 -G "version\\s*=\\s*\\(findProperty\\(\"${VERSION_PROP}\"\\)\\s*(as\\s*String\\?\\s*)?\\?\\:\\s*\"${BASE}-SNAPSHOT\"" --pretty=format:%H -- "$FILE" || true)
          [[ -n "$LAST_BASE_COMMIT" ]] || LAST_BASE_COMMIT=$(git rev-list --max-parents=0 HEAD -- "$MODULE_PATH")

          COUNT=$(git rev-list "${LAST_BASE_COMMIT}..HEAD" --count -- "$MODULE_PATH")
          NEW_MINOR=$(( MINOR + COUNT ))
          V="${MAJOR}.${NEW_MINOR}"

          echo "version=$V" >> "$GITHUB_OUTPUT"
          echo "Computed base=$BASE in $FILE; commits since base in ${MODULE_PATH}: $COUNT -> version=$V"

      - name: Verify secret present
        run: |
          test -n "${{ secrets.GPR_KEY }}" || (echo "Missing GPR_KEY" && exit 1)
          echo "Secret present."

  publish:
    runs-on: ubuntu-latest
    needs: compute_version
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Checkout central init scripts
        uses: actions/checkout@v4
        with:
          repository: Ruyi-Bang/packages
          path: .central
          fetch-depth: 1

      - uses: actions/setup-java@v4
        with:
          distribution: ${{ inputs.distribution }}
          java-version: ${{ inputs['java-version'] }}

      - uses: gradle/actions/setup-gradle@v4

      - name: Publish to GitHub Packages
        env:
          PUBLISH_URL: ${{ inputs['publish-url'] }}
          GPR_USER:    ${{ github.actor }}
          GPR_TOKEN:   ${{ secrets.GPR_KEY }}
          ORG_GRADLE_PROJECT_gpr.user:       ${{ github.actor }}
          ORG_GRADLE_PROJECT_gpr.token:      ${{ secrets.GPR_KEY }}
          ORG_GRADLE_PROJECT_githubUsername: ${{ github.actor }}
          ORG_GRADLE_PROJECT_githubToken:    ${{ secrets.GPR_KEY }}
        run: |
          INIT=".central/ci/init/github-packages.gradle"
          ./gradlew -I "$INIT" ${{ inputs['gradle-task'] }} \
            --no-daemon \
            -P${{ inputs['version-prop'] }}='${{ needs.compute_version.outputs.version }}' \
            ${{ inputs['extra-args'] }}
